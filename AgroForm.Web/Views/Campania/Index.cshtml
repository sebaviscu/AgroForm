@using AgroForm.Web.Models.IndexVM
@model CampaniasIndexVM
@{
    ViewData["Title"] = "Campañas";
}

<!-- Filtros y botón nueva campaña -->
<div class="row mb-3">
    <div class="col-md-4">
        <select id="estadoFilter" class="form-select">
            <option value="">Todos los estados</option>
            <option value="EnCurso">En curso</option>
            <option value="Finalizada">Finalizada</option>
            <option value="Cancelada">Cancelada</option>
        </select>
    </div>
    <div class="col-md-2">
        <button id="btnResetFilters" class="btn btn-secondary btn-sm w-100">
            <i class="ph ph-arrow-counter-clockwise"></i> Resetear
        </button>
    </div>
    <div class="col-md-3 offset-md-3 text-end">
        <button id="btnNuevaCampania" class="btn btn-primary btn-sm">
            <i class="ph ph-plus-circle me-1"></i> Nueva Campaña
        </button>
    </div>
</div>

<!-- Tabla principal -->
<table id="tblCampanias" class="table table-striped table-hover w-100">
    <thead>
        <tr>
            <th>Id</th>
            <th>Estado</th>
            <th>Nombre</th>
            <th>Fecha Inicio</th>
            <th>Fecha Fin</th>
            <th>Acciones</th>
        </tr>
    </thead>
</table>

<!-- Modal de Campañas -->
<div class="modal fade" id="modalCampania" tabindex="-1" aria-labelledby="modalCampaniaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <form id="formCampania" novalidate>
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCampaniaLabel">Nueva Campaña</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="campaniaTabs">
                        <li class="nav-item">
                            <button class="nav-link active" id="campos-tab" data-bs-toggle="tab" data-bs-target="#campos-pane" type="button" disabled>
                                Información Básica
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="lotes-tab" data-bs-toggle="tab" data-bs-target="#lotes-pane" type="button" disabled>
                                Campos y Lotes
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="resumen-tab" data-bs-toggle="tab" data-bs-target="#resumen-pane" type="button" disabled>
                                Resumen
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content pt-3">
                        <!-- TAB INFORMACIÓN BÁSICA -->
                        <div class="tab-pane fade show active" id="campos-pane">
                            <input type="hidden" id="idCampania">

                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label for="nombre" class="form-label">Nombre de Campaña <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="nombre" required>
                                    <div class="invalid-feedback">Por favor ingrese el nombre de la campaña</div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="fechaInicio" class="form-label">Fecha Inicio <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="fechaInicio" required>
                                    <div class="invalid-feedback">Por favor ingrese la fecha de inicio</div>
                                </div>
                            </div>
                        </div>



                        <!-- TAB CAMPOS Y LOTES -->
                        <div class="tab-pane fade" id="lotes-pane">
                            <h6 class="mb-3">Selección de Campos y Lotes</h6>

                            <!-- Selección de Campo -->
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6>Seleccionar Campo</h6>
                                    <div class="row g-2">
                                        <div class="col-md-6" style="align-content: center;">
                                            <select id="campoSeleccionadoLotes" class="form-select">
                                                <option value="">Seleccione un campo...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <div id="infoSuperficieCampo" class="mt-1 p-1 bg-light rounded" style="display:none;">
                                                <div class="row text-center">
                                                    <div class="col-6">
                                                        <strong id="campoSuperficieTotal">0.00</strong><br>
                                                        <small class="text-muted">Superficie Total</small>
                                                    </div>
                                                    <div class="col-6">
                                                        <strong id="campoSuperficieDisponible">0.00</strong><br>
                                                        <small class="text-muted">Superficie Disponible</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>

                            <!-- Agregar lote al campo seleccionado -->
                            <div class="card mb-3" id="formAgregarLote" style="display: none;">
                                <div class="card-body p-3">
                                    <h6>Agregar Lote al Campo: <span id="nombreCampoSeleccionado"></span></h6>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <input type="text" id="nuevoLoteNombre" class="form-control" placeholder="Nombre del lote" maxlength="100">
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" id="nuevoLoteSuperficie" class="form-control" placeholder="Superficie (Ha)" step="0.01" min="0.01">
                                        </div>
                                        <div class="col-md-2">
                                            <button id="btnAgregarLote" type="button" class="btn btn-success w-100">
                                                <i class="ph ph-plus-circle"></i> Agregar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Campos y sus lotes agregados -->
                            <div id="camposConLotes" class="">
                                <div class="text-center py-2 text-muted">
                                    <i class="ph ph-tray display-4"></i>
                                    <p class="mt-2">No hay campos agregados</p>
                                </div>
                            </div>

                            <!-- Resumen general -->
                            <div class="card">
                                <div class="card-body">
                                    <h6>Resumen General</h6>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <strong id="totalCamposAgregados">0</strong><br>
                                            <small class="text-muted">Campos</small>
                                        </div>
                                        <div class="col-4">
                                            <strong id="totalLotesAgregados">0</strong><br>
                                            <small class="text-muted">Lotes</small>
                                        </div>
                                        <div class="col-4">
                                            <strong id="totalSuperficieAgregada">0.00</strong><br>
                                            <small class="text-muted">Hectáreas</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB RESUMEN -->
                        <div class="tab-pane fade" id="resumen-pane">
                            <h5>Resumen de la Campaña</h5>
                            <ul class="list-group mb-3">
                                <li class="list-group-item"><strong>Nombre:</strong> <span id="resumenNombre"></span></li>
                                <li class="list-group-item"><strong>Estado:</strong> <span id="resumenEstado"></span></li>
                                <li class="list-group-item"><strong>Total Campos:</strong> <span id="resumenTotalCampos"></span></li>
                                <li class="list-group-item"><strong>Total Lotes:</strong> <span id="resumenTotalLotes"></span></li>
                                <li class="list-group-item"><strong>Superficie Total:</strong> <span id="resumenTotalSuperficie"></span> Ha</li>
                            </ul>

                            <h6>Detalle por Campo:</h6>
                            <div id="listaResumenCampos" class="mb-3"></div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="btnAnteriorCampos" class="btn btn-outline-secondary" style="display: none;">
                        <i class="ph ph-arrow-left"></i> Anterior
                    </button>
                    <button type="button" id="btnSiguienteLotes" class="btn btn-primary">
                        Siguiente <i class="ph ph-arrow-right"></i>
                    </button>
                    <button type="button" id="btnAnteriorLotes" class="btn btn-outline-secondary" style="display: none;">
                        <i class="ph ph-arrow-left"></i> Anterior
                    </button>
                    <button type="button" id="btnSiguienteResumen" class="btn btn-primary" style="display: none;">
                        Siguiente <i class="ph ph-arrow-right"></i>
                    </button>
                    <button type="submit" id="btnGuardarCampania" class="btn btn-success" style="display: none;">
                        <i class="ph ph-check-circle"></i> Guardar Campaña
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Template para campo con lotes -->
<div id="templateCampoConLotes" class="d-none">
    <div class="card mb-3 campo-lotes-card" data-campo-id="{{idCampo}}">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div class="d-flex justify-content-around">
                <h6 class="mb-0 me-3">{{campoNombre}}</h6>
                <i class="ph ph-map-pin"></i> {{campoUbicacion}}
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger btn-eliminar-campo" data-campo-id="{{idCampo}}">
                <i class="ph ph-trash"></i> Eliminar Campo
            </button>
        </div>
        <div class="card-body">
            <div class="lotes-container" id="lotes-{{idCampo}}">
                <!-- Lotes se agregarán aquí -->
            </div>
            <div class="mt-2 text-end">
                <small>
                    <strong>Lotes:</strong> <span class="lotes-count-{{idCampo}}">0</span> |
                    <strong>Superficie:</strong> <span class="superficie-total-{{idCampo}}">0.00</span> Ha |
                    <strong>Disponible:</strong> <span class="superficie-disponible-{{idCampo}}">0.00</span> Ha
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Template para campo con lotes EXISTENTES (sin botón eliminar) -->
<div id="templateCampoConLotesExistente" class="d-none">
    <div class="card mb-3 campo-lotes-card" data-campo-id="{{idCampo}}">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <h6 class="mb-0 me-3">{{campoNombre}}</h6>
                <i class="ph ph-map-pin ms-2"></i>
                <span class="ms-1">{{campoUbicacion}}</span>
            </div>
            <span class="badge bg-secondary">Campo Existente</span>
        </div>
        <div class="card-body">
            <div class="lotes-container" id="lotes-{{idCampo}}">
                <!-- Lotes se agregarán aquí -->
            </div>
            <div class="mt-2 text-end">
                <small>
                    <strong>Lotes:</strong> <span class="lotes-count-{{idCampo}}">0</span> |
                    <strong>Superficie:</strong> <span class="superficie-total-{{idCampo}}">0.00</span> Ha |
                    <strong>Disponible:</strong> <span class="superficie-disponible-{{idCampo}}">0.00</span> Ha
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Template para lote -->
<div id="templateLote" class="d-none">
    <div class="card mb-0 lote-card">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{nombre}}</strong>
                    <small class="text-muted ms-2">
                        <span class="badge bg-primary">{{superficie}} Ha</span>
                    </small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger btn-eliminar-lote" data-campo-id="{{idCampo}}" data-lote-id="{{IdLote}}">
                    <i class="ph ph-trash"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Template para lote existente (sin botón eliminar) -->
<div id="templateLoteExistente" class="d-none">
    <div class="card mb-0 lote-card">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{nombre}}</strong>
                    <small class="text-muted ms-2">
                        <span class="badge bg-primary">{{superficie}} Ha</span>
                        <span class="badge bg-secondary ms-1">Existente</span>
                    </small>
                </div>
                <small class="text-muted">No editable</small>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/views/campania.js" asp-append-version="true"></script>
}