@{
    ViewData["Title"] = "Configuración del Sistema";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12 mb-4">
            <h1 class="h2 fw-bold">
                <i class="bi bi-sliders me-2"></i>Configuración del Sistema
            </h1>
            <p class="text-muted mb-0">Administre los maestros y parámetros del sistema</p>
        </div>
    </div>

    <div class="row">
        <!-- Tabs Verticales -->
        <div class="col-md-3 col-lg-2">
            <div class="nav flex-column nav-pills me-3" id="configTabs" role="tablist" aria-orientation="vertical">
                <button class="nav-link active" id="general-tab" data-bs-toggle="pill" data-bs-target="#general" type="button" role="tab">
                    <i class="bi bi-house-gear me-2"></i>General
                </button>
                <button class="nav-link" id="campos-tab" data-bs-toggle="pill" data-bs-target="#campos" type="button" role="tab">
                    <i class="bi bi-building me-2"></i>Campos
                </button>
                <button class="nav-link" id="proveedores-tab" data-bs-toggle="pill" data-bs-target="#proveedores" type="button" role="tab">
                    <i class="bi bi-truck me-2"></i>Proveedores
                </button>
                <button class="nav-link" id="marcas-tab" data-bs-toggle="pill" data-bs-target="#marcas" type="button" role="tab">
                    <i class="bi bi-tags me-2"></i>Marcas
                </button>
            </div>
        </div>

        <!-- Contenido de Tabs -->
        <div class="col-md-9 col-lg-10">
            <div class="tab-content" id="configTabsContent">

                <!-- Tab General -->
                <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-info-circle me-2"></i>Información General del Sistema
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <i class="bi bi-building display-4 text-primary mb-3"></i>
                                            <h4 id="totalCampos">0</h4>
                                            <p class="text-muted mb-0">Campos Registrados</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <i class="bi bi-truck display-4 text-success mb-3"></i>
                                            <h4 id="totalProveedores">0</h4>
                                            <p class="text-muted mb-0">Proveedores Activos</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h6 class="fw-semibold">Resumen de Actividad Reciente</h6>
                                    <div class="list-group">
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <small>Último campo modificado</small>
                                                <small id="ultimoCampoFecha">-</small>
                                            </div>
                                            <small id="ultimoCampoUsuario" class="text-muted">-</small>
                                        </div>
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <small>Último proveedor modificado</small>
                                                <small id="ultimoProveedorFecha">-</small>
                                            </div>
                                            <small id="ultimoProveedorUsuario" class="text-muted">-</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Campos -->
                <div class="tab-pane fade" id="campos" role="tabpanel" aria-labelledby="campos-tab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-building me-2"></i>Gestión de Campos
                            </h5>
                            <button type="button" class="btn btn-primary btn-sm" onclick="abrirModalCampo()">
                                <i class="bi bi-plus-circle me-1"></i>Nuevo Campo
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="tblCampos" class="table table-hover table-striped w-100">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Ubicación</th>
                                            <th>Superficie (Ha)</th>
                                            <th>Fecha Registro</th>
                                            <th>Última Modificación</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Los datos se cargan via AJAX -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Proveedores -->
                <div class="tab-pane fade" id="proveedores" role="tabpanel" aria-labelledby="proveedores-tab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-truck me-2"></i>Gestión de Proveedores
                            </h5>
                            <button type="button" class="btn btn-primary btn-sm" onclick="abrirModalProveedor()">
                                <i class="bi bi-plus-circle me-1"></i>Nuevo Proveedor
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="tblProveedores" class="table table-hover table-striped w-100">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Razón Social</th>
                                            <th>Nombre Fantasía</th>
                                            <th>CUIT</th>
                                            <th>Teléfono</th>
                                            <th>Estado</th>
                                            <th>Última Modificación</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Los datos se cargan via AJAX -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Marcas -->
                <div class="tab-pane fade" id="marcas" role="tabpanel" aria-labelledby="marcas-tab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-tags me-2"></i>Gestión de Marcas
                            </h5>
                            <button type="button" class="btn btn-primary btn-sm" onclick="abrirModalMarca()">
                                <i class="bi bi-plus-circle me-1"></i>Nueva Marca
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="tblMarcas" class="table table-hover table-striped w-100">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Código</th>
                                            <th>Descripción</th>
                                            <th>Estado</th>
                                            <th>Fecha Registro</th>
                                            <th>Última Modificación</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Los datos se cargan via AJAX -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Campos -->
<div class="modal fade" id="modalCampo" tabindex="-1" aria-labelledby="modalCampoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalCampoLabel">
                    <i class="bi bi-building me-2"></i>Nuevo Campo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formCampo">
                <div class="modal-body">
                    <input type="hidden" id="campoId" name="Id" value="0">
                    <div class="mb-3">
                        <label for="campoNombre" class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="campoNombre" name="Nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="campoUbicacion" class="form-label">Ubicación</label>
                        <input type="text" class="form-control" id="campoUbicacion" name="Ubicacion">
                    </div>
                    <div class="mb-3">
                        <label for="campoSuperficie" class="form-label">Superficie (Hectáreas)</label>
                        <input type="number" class="form-control" id="campoSuperficie" name="SuperficieHectareas" step="0.01" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Proveedores -->
<div class="modal fade" id="modalProveedor" tabindex="-1" aria-labelledby="modalProveedorLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalProveedorLabel">
                    <i class="bi bi-truck me-2"></i>Nuevo Proveedor
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formProveedor">
                <div class="modal-body">
                    <input type="hidden" id="proveedorId" name="Id" value="0">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="proveedorRazonSocial" class="form-label">Razón Social *</label>
                                <input type="text" class="form-control" id="proveedorRazonSocial" name="RazonSocial" required>
                            </div>
                            <div class="mb-3">
                                <label for="proveedorNombreFantasia" class="form-label">Nombre Fantasía</label>
                                <input type="text" class="form-control" id="proveedorNombreFantasia" name="NombreFantasia">
                            </div>
                            <div class="mb-3">
                                <label for="proveedorCUIT" class="form-label">CUIT</label>
                                <input type="text" class="form-control" id="proveedorCUIT" name="CUIT">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="proveedorTelefono" class="form-label">Teléfono</label>
                                <input type="text" class="form-control" id="proveedorTelefono" name="Telefono">
                            </div>
                            <div class="mb-3">
                                <label for="proveedorEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="proveedorEmail" name="Email">
                            </div>
                            <div class="mb-3">
                                <label for="proveedorNombreContacto" class="form-label">Nombre de Contacto</label>
                                <input type="text" class="form-control" id="proveedorNombreContacto" name="NombreContacto">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="proveedorDireccion" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="proveedorDireccion" name="Direccion">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="proveedorLocalidad" class="form-label">Localidad</label>
                                <input type="text" class="form-control" id="proveedorLocalidad" name="Localidad">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="proveedorObservaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="proveedorObservaciones" name="Observaciones" rows="3"></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="proveedorActivo" name="Activo" checked>
                        <label class="form-check-label" for="proveedorActivo">Activo</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Marcas -->
<div class="modal fade" id="modalMarca" tabindex="-1" aria-labelledby="modalMarcaLavel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalMarcaLavel">
                    <i class="bi bi-tags me-2"></i>Nueva Marca
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formMarca">
                <div class="modal-body">
                    <input type="hidden" id="marcaId" name="Id" value="0">
                    <div class="mb-3">
                        <label for="marcaCodigo" class="form-label">Código *</label>
                        <input type="text" class="form-control" id="marcaCodigo" name="Codigo" required>
                    </div>
                    <div class="mb-3">
                        <label for="marcaDescripcion" class="form-label">Descripción *</label>
                        <input type="text" class="form-control" id="marcaDescripcion" name="Descripcion" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="marcaActivo" name="Activo" checked>
                        <label class="form-check-label" for="marcaActivo">Activo</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script>
        // Variables globales para DataTables
        var tableCampos, tableProveedores, tableMarcas;

        $(document).ready(function () {
            // Inicializar DataTables cuando se active cada tab
            $('#configTabs').on('shown.bs.tab', function (e) {
                var target = $(e.target).attr("data-bs-target");

                switch(target) {
                    case '#general':
                        cargarResumenGeneral();
                        break;
                    case '#campos':
                        inicializarTablaCampos();
                        break;
                    case '#proveedores':
                        inicializarTablaProveedores();
                        break;
                    case '#marcas':
                        inicializarTablaMarcas();
                        break;
                }
            });

            // Activar el tab general al cargar
            cargarResumenGeneral();

            // Configurar formularios
            configurarFormularios();
        });

        // ===== FUNCIONES GENERALES =====
        function cargarResumenGeneral() {
            $.when(
                $.get('@Url.Action("GetAll", "Campo")'),
                $.get('@Url.Action("GetAll", "Proveedor")'),
                $.get('@Url.Action("GetAll", "Marca")')
            ).done(function(camposResponse, proveedoresResponse, marcasResponse) {
                // Actualizar contadores
                $('#totalCampos').text(camposResponse[0].data ? camposResponse[0].data.length : 0);
                $('#totalProveedores').text(proveedoresResponse[0].data ?
                    proveedoresResponse[0].data.filter(p => p.activo).length : 0);

                // Encontrar últimas modificaciones
                var ultimoCampo = camposResponse[0].data ?
                    camposResponse[0].data.sort((a, b) => new Date(b.modificationDate || b.registrationDate) - new Date(a.modificationDate || a.registrationDate))[0] : null;

                var ultimoProveedor = proveedoresResponse[0].data ?
                    proveedoresResponse[0].data.sort((a, b) => new Date(b.modificationDate || b.registrationDate) - new Date(a.modificationDate || a.registrationDate))[0] : null;

                // Actualizar información de actividad
                if (ultimoCampo) {
                    $('#ultimoCampoFecha').text(formatearFecha(ultimoCampo.modificationDate || ultimoCampo.registrationDate));
                    $('#ultimoCampoUsuario').text('Por: ' + (ultimoCampo.modificationUser || ultimoCampo.registrationUser || 'Sistema'));
                }

                if (ultimoProveedor) {
                    $('#ultimoProveedorFecha').text(formatearFecha(ultimoProveedor.modificationDate || ultimoProveedor.registrationDate));
                    $('#ultimoProveedorUsuario').text('Por: ' + (ultimoProveedor.modificationUser || ultimoProveedor.registrationUser || 'Sistema'));
                }
            });
        }

        function formatearFecha(fechaString) {
            if (!fechaString) return '-';
            const fecha = new Date(fechaString);
            return fecha.toLocaleDateString('es-ES') + ' ' + fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        }

        function formatearFechaCorta(fechaString) {
            if (!fechaString) return '-';
            const fecha = new Date(fechaString);
            return fecha.toLocaleDateString('es-ES');
        }

        // ===== FUNCIONES PARA CAMPOS =====
        function inicializarTablaCampos() {
            if ($.fn.DataTable.isDataTable('#tblCampos')) {
                tableCampos.destroy();
            }

            tableCampos = $('#tblCampos').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
                },
                ajax: {
                    url: '@Url.Action("GetAll", "Campo")',
                    dataSrc: 'data'
                },
                columns: [
                    { data: 'nombre' },
                    { data: 'ubicacion', defaultContent: '-' },
                    {
                        data: 'superficieHectareas',
                        render: function(data) {
                            return data ? parseFloat(data).toFixed(2) + ' Ha' : '-';
                        }
                    },
                    {
                        data: 'registrationDate',
                        render: function(data) {
                            return formatearFechaCorta(data);
                        }
                    },
                    {
                        data: 'modificationDate',
                        render: function(data, type, row) {
                            if (data) {
                                return formatearFecha(data) + '<br><small class="text-muted">' + (row.modificationUser || 'Sistema') + '</small>';
                            }
                            return '-';
                        }
                    },
                    {
                        data: 'id',
                        render: function(data) {
                            return `
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary btn-editar-campo" data-id="${data}" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-eliminar-campo" data-id="${data}" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            `;
                        },
                        className: 'text-center'
                    }
                ],
                order: [[0, 'asc']],
                pageLength: 10,
                responsive: true
            });

            // Eventos para botones de campos
            $('#tblCampos tbody').on('click', '.btn-editar-campo', function () {
                var id = $(this).data('id');
                editarCampo(id);
            });

            $('#tblCampos tbody').on('click', '.btn-eliminar-campo', function () {
                var id = $(this).data('id');
                eliminarCampo(id);
            });
        }

        function abrirModalCampo(id = 0) {
            $('#campoId').val(id);
            $('#modalCampoLabel').html(id === 0 ?
                '<i class="bi bi-building me-2"></i>Nuevo Campo' :
                '<i class="bi bi-building me-2"></i>Editar Campo');

            if (id === 0) {
                $('#formCampo')[0].reset();
            } else {
                // Cargar datos del campo
                $.get('@Url.Action("Get", "Campo")/' + id, function(response) {
                    if (response.success) {
                        var campo = response.data;
                        $('#campoNombre').val(campo.nombre);
                        $('#campoUbicacion').val(campo.ubicacion || '');
                        $('#campoSuperficie').val(campo.superficieHectareas || '');
                    }
                });
            }

            $('#modalCampo').modal('show');
        }

        function editarCampo(id) {
            abrirModalCampo(id);
        }

        function eliminarCampo(id) {
            if (!confirm('¿Está seguro de que desea eliminar este campo?')) return;

            $.ajax({
                url: '@Url.Action("Delete", "Campo")/' + id,
                type: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        tableCampos.ajax.reload();
                        cargarResumenGeneral();
                        mostrarMensaje('Campo eliminado correctamente', 'success');
                    } else {
                        mostrarMensaje(response.message || 'Error al eliminar campo', 'error');
                    }
                }
            });
        }

        // ===== FUNCIONES PARA PROVEEDORES =====
        function inicializarTablaProveedores() {
            if ($.fn.DataTable.isDataTable('#tblProveedores')) {
                tableProveedores.destroy();
            }

            tableProveedores = $('#tblProveedores').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
                },
                ajax: {
                    url: '@Url.Action("GetAll", "Proveedor")',
                    dataSrc: 'data'
                },
                columns: [
                    { data: 'razonSocial' },
                    { data: 'nombreFantasia', defaultContent: '-' },
                    { data: 'cuit', defaultContent: '-' },
                    { data: 'telefono', defaultContent: '-' },
                    {
                        data: 'activo',
                        render: function(data) {
                            return data ?
                                '<span class="badge bg-success">Activo</span>' :
                                '<span class="badge bg-danger">Inactivo</span>';
                        }
                    },
                    {
                        data: 'modificationDate',
                        render: function(data, type, row) {
                            if (data) {
                                return formatearFecha(data) + '<br><small class="text-muted">' + (row.modificationUser || 'Sistema') + '</small>';
                            }
                            return '-';
                        }
                    },
                    {
                        data: 'id',
                        render: function(data, type, row) {
                            return `
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary btn-editar-proveedor" data-id="${data}" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-eliminar-proveedor" data-id="${data}" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            `;
                        },
                        className: 'text-center'
                    }
                ],
                order: [[0, 'asc']],
                pageLength: 10,
                responsive: true
            });

            // Eventos para botones de proveedores
            $('#tblProveedores tbody').on('click', '.btn-editar-proveedor', function () {
                var id = $(this).data('id');
                editarProveedor(id);
            });

            $('#tblProveedores tbody').on('click', '.btn-eliminar-proveedor', function () {
                var id = $(this).data('id');
                eliminarProveedor(id);
            });
        }

        function abrirModalProveedor(id = 0) {
            $('#proveedorId').val(id);
            $('#modalProveedorLabel').html(id === 0 ?
                '<i class="bi bi-truck me-2"></i>Nuevo Proveedor' :
                '<i class="bi bi-truck me-2"></i>Editar Proveedor');

            if (id === 0) {
                $('#formProveedor')[0].reset();
                $('#proveedorActivo').prop('checked', true);
            } else {
                // Cargar datos del proveedor
                $.get('@Url.Action("Get", "Proveedor")/' + id, function(response) {
                    if (response.success) {
                        var proveedor = response.data;
                        $('#proveedorRazonSocial').val(proveedor.razonSocial);
                        $('#proveedorNombreFantasia').val(proveedor.nombreFantasia || '');
                        $('#proveedorCUIT').val(proveedor.cuit || '');
                        $('#proveedorDireccion').val(proveedor.direccion || '');
                        $('#proveedorLocalidad').val(proveedor.localidad || '');
                        $('#proveedorTelefono').val(proveedor.telefono || '');
                        $('#proveedorEmail').val(proveedor.email || '');
                        $('#proveedorNombreContacto').val(proveedor.nombreContacto || '');
                        $('#proveedorObservaciones').val(proveedor.observaciones || '');
                        $('#proveedorActivo').prop('checked', proveedor.activo);
                    }
                });
            }

            $('#modalProveedor').modal('show');
        }

        function editarProveedor(id) {
            abrirModalProveedor(id);
        }

        function eliminarProveedor(id) {
            if (!confirm('¿Está seguro de que desea eliminar este proveedor?')) return;

            $.ajax({
                url: '@Url.Action("Delete", "Proveedor")/' + id,
                type: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        tableProveedores.ajax.reload();
                        cargarResumenGeneral();
                        mostrarMensaje('Proveedor eliminado correctamente', 'success');
                    } else {
                        mostrarMensaje(response.message || 'Error al eliminar proveedor', 'error');
                    }
                }
            });
        }

        // ===== FUNCIONES PARA MARCAS =====
        function inicializarTablaMarcas() {
            if ($.fn.DataTable.isDataTable('#tblMarcas')) {
                tableMarcas.destroy();
            }

            tableMarcas = $('#tblMarcas').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
                },
                ajax: {
                    url: '@Url.Action("GetAll", "Marca")',
                    dataSrc: 'data'
                },
                columns: [
                    { data: 'codigo' },
                    { data: 'descripcion' },
                    {
                        data: 'activo',
                        render: function(data) {
                            return data ?
                                '<span class="badge bg-success">Activa</span>' :
                                '<span class="badge bg-danger">Inactiva</span>';
                        }
                    },
                    {
                        data: 'registrationDate',
                        render: function(data) {
                            return formatearFechaCorta(data);
                        }
                    },
                    {
                        data: 'modificationDate',
                        render: function(data, type, row) {
                            if (data) {
                                return formatearFecha(data) + '<br><small class="text-muted">' + (row.modificationUser || 'Sistema') + '</small>';
                            }
                            return '-';
                        }
                    },
                    {
                        data: 'id',
                        render: function(data, type, row) {
                            return `
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary btn-editar-marca" data-id="${data}" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-eliminar-marca" data-id="${data}" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            `;
                        },
                        className: 'text-center'
                    }
                ],
                order: [[0, 'asc']],
                pageLength: 10,
                responsive: true
            });

            // Eventos para botones de marcas
            $('#tblMarcas tbody').on('click', '.btn-editar-marca', function () {
                var id = $(this).data('id');
                editarMarca(id);
            });

            $('#tblMarcas tbody').on('click', '.btn-eliminar-marca', function () {
                var id = $(this).data('id');
                eliminarMarca(id);
            });
        }

        function abrirModalMarca(id = 0) {
            $('#marcaId').val(id);
            $('#modalMarcaLavel').html(id === 0 ?
                '<i class="bi bi-tags me-2"></i>Nueva Marca' :
                '<i class="bi bi-tags me-2"></i>Editar Marca');

            if (id === 0) {
                $('#formMarca')[0].reset();
                $('#marcaActivo').prop('checked', true);
            } else {
                // Cargar datos de la marca
                $.get('@Url.Action("Get", "Marca")/' + id, function(response) {
                    if (response.success) {
                        var marca = response.data;
                        $('#marcaCodigo').val(marca.codigo);
                        $('#marcaDescripcion').val(marca.descripcion);
                        $('#marcaActivo').prop('checked', marca.activo);
                    }
                });
            }

            $('#modalMarca').modal('show');
        }

        function editarMarca(id) {
            abrirModalMarca(id);
        }

        function eliminarMarca(id) {
            if (!confirm('¿Está seguro de que desea eliminar esta marca?')) return;

            $.ajax({
                url: '@Url.Action("Delete", "Marca")/' + id,
                type: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        tableMarcas.ajax.reload();
                        cargarResumenGeneral();
                        mostrarMensaje('Marca eliminada correctamente', 'success');
                    } else {
                        mostrarMensaje(response.message || 'Error al eliminar marca', 'error');
                    }
                }
            });
        }

        // ===== CONFIGURACIÓN DE FORMULARIOS =====
        function configurarFormularios() {
            // Formulario de Campos
            $('#formCampo').on('submit', function(e) {
                e.preventDefault();
                guardarCampo();
            });

            // Formulario de Proveedores
            $('#formProveedor').on('submit', function(e) {
                e.preventDefault();
                guardarProveedor();
            });

            // Formulario de Marcas
            $('#formMarca').on('submit', function(e) {
                e.preventDefault();
                guardarMarca();
            });
        }

        function guardarCampo() {
            var formData = {
                Id: $('#campoId').val(),
                Nombre: $('#campoNombre').val(),
                Ubicacion: $('#campoUbicacion').val(),
                SuperficieHectareas: $('#campoSuperficie').val() || null
            };

            var url = formData.Id == 0 ? '@Url.Action("Create", "Campo")' : '@Url.Action("Update", "Campo")';
            var method = formData.Id == 0 ? 'POST' : 'PUT';

            $.ajax({
                url: url,
                type: method,
                data: formData,
                success: function(response) {
                    if (response.success) {
                        $('#modalCampo').modal('hide');
                        tableCampos.ajax.reload();
                        cargarResumenGeneral();
                        mostrarMensaje('Campo guardado correctamente', 'success');
                    } else {
                        mostrarMensaje(response.message || 'Error al guardar campo', 'error');
                    }
                }
            });
        }

        function guardarProveedor() {
            var formData = {
                Id: $('#proveedorId').val(),
                RazonSocial: $('#proveedorRazonSocial').val(),
                NombreFantasia: $('#proveedorNombreFantasia').val(),
                CUIT: $('#proveedorCUIT').val(),
                Direccion: $('#proveedorDireccion').val(),
                Localidad: $('#proveedorLocalidad').val(),
                Telefono: $('#proveedorTelefono').val(),
                Email: $('#proveedorEmail').val(),
                NombreContacto: $('#proveedorNombreContacto').val(),
                Observaciones: $('#proveedorObservaciones').val(),
                Activo: $('#proveedorActivo').is(':checked')
            };

            var url = formData.Id == 0 ? '@Url.Action("Create", "Proveedor")' : '@Url.Action("Update", "Proveedor")';
            var method = formData.Id == 0 ? 'POST' : 'PUT';

            $.ajax({
                url: url,
                type: method,
                data: formData,
                success: function(response) {
                    if (response.success) {
                        $('#modalProveedor').modal('hide');
                        tableProveedores.ajax.reload();
                        cargarResumenGeneral();
                        mostrarMensaje('Proveedor guardado correctamente', 'success');
                    } else {
                        mostrarMensaje(response.message || 'Error al guardar proveedor', 'error');
                    }
                }
            });
        }

        function guardarMarca() {
            var formData = {
                Id: $('#marcaId').val(),
                Codigo: $('#marcaCodigo').val(),
                Descripcion: $('#marcaDescripcion').val(),
                Activo: $('#marcaActivo').is(':checked')
            };

            var url = formData.Id == 0 ? '@Url.Action("Create", "Marca")' : '@Url.Action("Update", "Marca")';
            var method = formData.Id == 0 ? 'POST' : 'PUT';

            $.ajax({
                url: url,
                type: method,
                data: formData,
                success: function(response) {
                    if (response.success) {
                        $('#modalMarca').modal('hide');
                        tableMarcas.ajax.reload();
                        cargarResumenGeneral();
                        mostrarMensaje('Marca guardada correctamente', 'success');
                    } else {
                        mostrarMensaje(response.message || 'Error al guardar marca', 'error');
                    }
                }
            });
        }

        // ===== FUNCIÓN PARA MOSTRAR MENSAJES =====
        function mostrarMensaje(mensaje, tipo) {
            // Puedes usar Toastr, SweetAlert o el método que prefieras
            if (tipo === 'success') {
                toastr.success(mensaje);
            } else {
                toastr.error(mensaje);
            }
        }
    </script>
}