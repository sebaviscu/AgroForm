<div class="dashboard-stats">
    <h4 class="mb-4">
        <i class="ph ph-map text-success me-2"></i>Campos y Lotes
    </h4>

    <!-- Selector de Campos -->
    <div class="mb-3">
        <label class="form-label fw-semibold">Seleccionar Campo:</label>
        <select id="campoSelector" class="form-select">
            <option value="">Todos los campos</option>
        </select>
    </div>

    <!-- Loading -->
    <div id="loadingCamposActividades" class="text-center py-3">
        <div class="spinner-border spinner-border-sm text-info" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <small class="text-muted ms-2">Cargando Campos y Lotes...</small>
    </div>

    <!-- Lista de Campos y Lotes -->
    <div class="campos-lotes-container" id="camposLotesList">
        <!-- Se llenará dinámicamente -->
    </div>
</div>

<script>
        $(document).ready(function() {
        // Cargar campos en el selector
        cargarCamposActividades();

        // Cargar campos y lotes con actividades al iniciar
        cargarCamposYLotes();

        // Filtrar por campo seleccionado
        $('#campoSelector').change(function() {
            filtrarPorCampo($(this).val());
        });
    });

    // Función para cargar campos en el selector
    function cargarCamposActividades() {
        $.ajax({
            url: '@Url.Action("GetAll", "Campo")',
            type: 'GET',
            success: function(result) {
                if (result.success && result.listObject) {
                    var $selector = $('#campoSelector');
                    $selector.empty().append('<option value="">Todos los campos</option>');

                    result.listObject.forEach(function(campo) {
                        $selector.append($('<option>', {
                            value: campo.id,
                            text: campo.nombre
                        }));
                    });
                }
            },
            error: function(error) {
                console.error('Error al cargar campos:', error);
            }
        });
    }

    // Función para cargar campos, lotes y actividades
    function cargarCamposYLotes() {
        $.ajax({
            url: '/Campo/GetCamposConLotesYActividades',
            type: 'GET',
            success: function(result) {
                    $('#loadingCamposActividades').hide();
                if (result.success && result.listObject) {
                    renderizarCamposYLotes(result.listObject);
                } else {
                    $('#camposLotesList').html('<div class="alert alert-warning">No se pudieron cargar los datos</div>');
                }
            },
            error: function(xhr, status, error) {
                    $('#loadingCamposActividades').hide();
                console.error('Error cargando campos y lotes:', error);
                $('#camposLotesList').html('<div class="alert alert-danger">Error al cargar los datos</div>');
            }
        });
    }

    // Función para renderizar campos y lotes
    function renderizarCamposYLotes(campos) {
        var $container = $('#camposLotesList');
        $container.empty();

        if (!campos || campos.length === 0) {
            $container.html('<div class="alert alert-info">No se encontraron campos con actividades</div>');
            return;
        }

        $.each(campos, function(index, campo) {
            var $campoElement = crearCampoElement(campo);
            $container.append($campoElement);
        });
    }

    // Función para crear elemento de campo
    function crearCampoElement(campo) {
        var superficieText = campo.superficieHectareas ?
            '<small class="text-muted">(' + campo.superficieHectareas + ' ha)</small>' : '';

        var $campoDiv = $('<div>', {
            class: 'card mb-3 campo-item',
            'data-campo-id': campo.id
        });

        var $cardHeader = $('<div>', {
            class: 'card-header bg-light d-flex justify-content-between align-items-center'
        }).html(
            '<h6 class="mb-0">' +
            '<i class="ph ph-map-pin text-primary me-2"></i>' +
            campo.nombre +
            (campo.ubicacion ? ' - ' + campo.ubicacion : '') +
            ' ' + superficieText +
            '</h6>' +
            '<span class="badge bg-secondary">' + (campo.lotes ? campo.lotes.length : 0) + ' lote(s)</span>'
        );

        var $cardBody = $('<div>', {
            class: 'card-body p-2'
        });

        var $lotesList = $('<div>', {
            class: 'lotes-list'
        });

        if (campo.lotes && campo.lotes.length > 0) {
            $.each(campo.lotes, function(index, lote) {
                var $loteElement = crearLoteElement(lote);
                $lotesList.append($loteElement);
            });
        } else {
            $lotesList.append(
                $('<p>', {
                    class: 'text-muted text-center',
                    text: 'No hay lotes en este campo'
                })
            );
        }

        $cardBody.append($lotesList);
        $campoDiv.append($cardHeader, $cardBody);

        return $campoDiv;
    }

    // Función para crear elemento de lote
    function crearLoteElement(lote) {
        var superficieText = lote.superficieHectareas ?
            '<small class="text-muted">(' + lote.superficieHectareas + ' ha)</small>' : '';

        var $loteDiv = $('<div>', {
            class: 'lote-item border rounded p-2 mb-2'
        });

        var $loteHeader = $('<div>', {
            class: 'd-flex justify-content-between align-items-center mb-2'
        }).html(
            '<h6 class="mb-0">' +
            // '<i class="ph ph-square text-success me-2"></i>' +
            lote.nombre +
            ' ' + superficieText +
            '</h6>' +
            '<span class="badge bg-info">' + (lote.actividades ? lote.actividades.length : 0) + ' actividad(es)</span>'
        );

        $loteDiv.append($loteHeader);

        if (lote.actividades && lote.actividades.length > 0) {
            // var $actividadesTitle = $('<h6>', {
            //     class: 'text-muted mb-2',
            //     text: 'Actividades:'
            // });

            var $actividadesList = $('<div>', {
                class: 'actividades-list'
            });

            // Ordenar actividades por fecha (más reciente primero)
            var actividadesOrdenadas = lote.actividades.sort(function(a, b) {
                return new Date(b.fecha) - new Date(a.fecha);
            });

            $.each(actividadesOrdenadas, function(index, actividad) {
                var $actividadElement = crearActividadElement(actividad);
                $actividadesList.append($actividadElement);
            });

            // $loteDiv.append($actividadesTitle, $actividadesList);
            $loteDiv.append($actividadesList);
        } else {
            $loteDiv.append(
                $('<p>', {
                    class: 'text-muted mb-0',
                    text: 'No hay actividades registradas'
                })
            );
        }

        return $loteDiv;
    }

    // Función para crear elemento de actividad
            function crearActividadElement(actividad) {
        var fecha = new Date(actividad.fecha).toLocaleDateString();
        var tieneInsumo = actividad.insumo && actividad.cantidadInsumo;
        var icono = actividad.iconoTipoActividad || 'ph ph-activity';

        var $actividadDiv = $('<div>', {
            class: 'actividad-item border-start border-3 border-primary ps-2 py-1 mb-2'
        });

        var $flexContainer = $('<div>', {
            class: 'd-flex align-items-start'
        });

        // Icono
        var $iconContainer = $('<div>', {
            class: 'me-2 flex-shrink-0'
        }).html('<i class="' + icono + ' text-primary"></i>');

        // Contenedor principal del contenido
        var $contentContainer = $('<div>', {
            class: 'flex-grow-1'
        });

        // Fila 1: Tipo de actividad + Insumo
        var fila1Html = '<div class="d-flex align-items-baseline">' +
            '<strong class="text-dark me-2">' + (actividad.tipoActividad || 'Actividad') + '</strong>';

        if (tieneInsumo) {
            fila1Html += '<small class="text-muted">' +
                actividad.insumo + ': ' + actividad.cantidadInsumo + (actividad.unidadMedida ? ' ' + actividad.unidadMedida : '') +
                '</small>';
        }

        fila1Html += '</div>';
        $contentContainer.append(fila1Html);

        // Fila 2: Responsable y Lote
        var fila2Html = '<div class="d-flex align-items-center text-muted small mt-1">' +
            '<span class="text-primary me-2">' + (actividad.registrationUser || 'Sin responsable') + '</span>' +
            '<span>' + (actividad.lote || 'Sin lote') + '</span>' +
            '</div>';
        $contentContainer.append(fila2Html);

        // Fila 3: Observación corta
        if (actividad.observacionCortada) {
            var fila3Html = '<div class="actividad-observacion text-muted small mt-1" style="cursor: crosshair;" ' +
                'data-bs-toggle="tooltip" data-bs-placement="top" title="' + (actividad.observacion || '') + '">' +
                '- ' + actividad.observacionCortada +
                '</div>';
            $contentContainer.append(fila3Html);
        }

        // Fecha (puede ir en la esquina derecha del header si querés)
        var $fechaContainer = $('<div>', {
            class: 'actividad-fecha flex-shrink-0 ms-2 small text-muted'
        }).text(fecha);

        $flexContainer.append($iconContainer, $contentContainer, $fechaContainer);
        $actividadDiv.append($flexContainer);

        return $actividadDiv;
    }


    // Función para filtrar por campo
    function filtrarPorCampo(campoId) {
        $('.campo-item').each(function() {
            var $campo = $(this);
            if (!campoId || $campo.data('campo-id') == campoId) {
                $campo.show();
            } else {
                $campo.hide();
            }
        });
    }
</script>

<style>
    .campo-item {
        transition: all 0.3s ease;
    }

    .lote-item {
        background-color: #f8f9fa;
        transition: all 0.2s ease;
    }

        .lote-item:hover {
            background-color: #e9ecef;
        }

    .actividad-item {
        background-color: white;
        border-radius: 0.25rem;
    }

        .actividad-item:hover {
            background-color: #f8f9fa;
        }

    .badge {
        font-size: 0.7rem;
    }
</style>