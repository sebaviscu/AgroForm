
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">

            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="ph ph-map-trifold text-succsess me-2" style="color: green"></i>
                    <span id="tituloGrafico">Campos</span>
                </h5>

                <div class="d-flex gap-2">
                    <!-- Filtro por Campo -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="ph ph-map-trifold me-1"></i>
                            <span id="filtroCampoActividadText">Todos los Campos</span>
                        </button>
                        <ul class="dropdown-menu" id="filtroCampoActividadMenu">
                            <li><a class="dropdown-item filtro-campo-actividad active" href="#" data-campo-id="0">Todos los Campos</a></li>
                        </ul>
                    </div>

                </div>
            </div>

            <div class="card-body">
                <div class="row">

                    <!-- Loading -->
                    <div id="loadingCamposActividades" class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-info" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <small class="text-muted ms-2">Cargando Campos y Lotes...</small>
                    </div>

                    <!-- Lista de Campos y Lotes -->
                    <div class="campos-lotes-container" id="camposLotesList">
                        <!-- Se llenará dinámicamente -->
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

@* </div> *@

<script>
        $(document).ready(function() {

        cargarCamposYLotes();

        $(document).on('click', '.filtro-campo-actividad', function(e) {
            e.preventDefault();
            campoActual = $(this).data('campo-id');
            $('#filtroCampoActividadText').text($(this).text());

             filtrarPorCampo(campoActual);
        });


    });


    // Función para cargar campos, lotes y actividades
    function cargarCamposYLotes() {
        $.ajax({
            url: '/Campo/GetCamposConLotesYActividades',
            type: 'GET',
            success: function(result) {
                    $('#loadingCamposActividades').hide();
                if (result.success && result.listObject) {
                    renderizarCamposYLotes(result.listObject);
                    inicializarPopovers();
                } else {
                    $('#camposLotesList').html('<div class="alert alert-warning">No se pudieron cargar los datos</div>');
                }
            },
            error: function(xhr, status, error) {
                    $('#loadingCamposActividades').hide();
                console.error('Error cargando campos y lotes:', error);
                $('#camposLotesList').html('<div class="alert alert-danger">Error al cargar los datos</div>');
            }
        });
    }

    // Función para renderizar campos y lotes
    function renderizarCamposYLotes(campos) {
        var $container = $('#camposLotesList');
        $container.empty();

        if (!campos || campos.length === 0) {
            $container.html('<div class="alert alert-info">No se encontraron campos con actividades</div>');
            return;
        }

        $.each(campos, function(index, campo) {
            var $campoElement = crearCampoElement(campo);
            $container.append($campoElement);
        });

    }

    // Función para crear elemento de campo
    function crearCampoElement(campo) {
        var superficieText = campo.superficieHectareas ?
            '<small class="text-muted">(' + campo.superficieHectareas + ' ha)</small>' : '';

        var $campoDiv = $('<div>', {
            class: 'card mb-3 campo-item',
            'data-campo-id': campo.id
        });

        var $cardHeader = $('<div>', {
            class: 'card-header bg-light d-flex justify-content-between align-items-center'
        }).html(
            '<h6 class="mb-0">' +
            '<i class="ph ph-map-pin text-primary me-2"></i>' +
            campo.nombre +
            (campo.ubicacion ? ' - ' + campo.ubicacion : '') +
            ' ' + superficieText +
            '</h6>'
        );

        var $cardBody = $('<div>', {
            class: 'card-body p-2'
        });

        var $lotesList = $('<div>', {
            class: 'lotes-list'
        });

        if (campo.lotes && campo.lotes.length > 0) {
            $.each(campo.lotes, function(index, lote) {
                var $loteElement = crearLoteElement(lote);
                $lotesList.append($loteElement);
            });
        } else {
            $lotesList.append(
                $('<p>', {
                    class: 'text-muted text-center',
                    text: 'No hay lotes en este campo'
                })
            );
        }

        $cardBody.append($lotesList);
        $campoDiv.append($cardHeader, $cardBody);

        return $campoDiv;
    }

    // Función para crear elemento de lote
    function crearLoteElement(lote) {
        var superficieText = lote.superficieHectareas ?
            '<small class="text-muted">(' + lote.superficieHectareas + ' ha)</small>' : '';

        var $loteDiv = $('<div>', {
            class: 'lote-item border rounded p-2 mb-2'
        });

        var $loteHeader = $('<div>', {
            class: 'd-flex justify-content-between align-items-center mb-2'
        }).html(
            '<h6 class="mb-0">' +
            // '<i class="ph ph-square text-success me-2"></i>' +
            lote.nombre +
            ' ' + superficieText +
            '</h6>' +
            '<span class="badge bg-info">' + (lote.actividades ? lote.actividades.length : 0) + ' actividad(es)</span>'
        );

        $loteDiv.append($loteHeader);

        if (lote.actividades && lote.actividades.length > 0) {
            // var $actividadesTitle = $('<h6>', {
            //     class: 'text-muted mb-2',
            //     text: 'Actividades:'
            // });

            var $actividadesList = $('<div>', {
                class: 'actividades-list'
            });

            // Ordenar actividades por fecha (más reciente primero)
            var actividadesOrdenadas = lote.actividades.sort(function(a, b) {
                return new Date(b.fecha) - new Date(a.fecha);
            });

            $.each(actividadesOrdenadas, function(index, actividad) {
                var $actividadElement = crearActividadElement(actividad);
                $actividadesList.append($actividadElement);
            });

            // $loteDiv.append($actividadesTitle, $actividadesList);
            $loteDiv.append($actividadesList);
        } else {
            $loteDiv.append(
                $('<p>', {
                    class: 'text-muted mb-0',
                    text: 'No hay actividades registradas'
                })
            );
        }

        return $loteDiv;
    }


    function inicializarPopovers() {
        $('[data-bs-toggle="popover"]').each(function() {
            var existing = bootstrap.Popover.getInstance(this);
            if (existing) existing.dispose();
            new bootstrap.Popover(this, {
                container: 'body',
                trigger: $(this).data('bs-trigger') || 'focus',
                html: $(this).data('bs-html') === true || $(this).data('bs-html') === 'true'
            });
        });
    }


    // Función para crear elemento de actividad
    function crearActividadElement(actividad) {
        var fecha = new Date(actividad.fecha).toLocaleDateString();
        var icono = actividad.iconoTipoActividad || 'ph ph-activity';
        var colorIcono = actividad.iconoColorTipoActividad;

        var $actividadDiv = $('<div>', {
            class: 'actividad-item border-start border-3 border-primary ps-2 py-1 mb-2'
        });

        var $flexContainer = $('<div>', {
            class: 'd-flex align-items-start'
        });

        // Icono
        var $iconContainer = $('<div>', {
            class: 'me-2 flex-shrink-0'
        }).html('<div class="actividad-icono me-2 flex-shrink-0"> <i class="ph ' + icono + '" style="color:' + colorIcono + '"></i> </div>');

        // Contenedor principal del contenido
        var $contentContainer = $('<div>', {
            class: 'flex-grow-1'
        });

        // Fila 1: Tipo de actividad + Insumo
        var fila1Html = '<div class="d-flex align-items-baseline">' +
            '<strong class="text-dark me-2">' + (actividad.tipoActividad || 'Actividad') + '</strong>';


        fila1Html += `<div class="actividad-insumo text-muted small">
                            <i class="ph ph-eye ms-1"
                                role="button"
                                tabindex="0"
                                data-bs-toggle="popover"
                                data-bs-trigger="focus"
                                data-bs-html="true"
                                title="Detalle de la labor"
                                data-bs-content="${
                                    actividad.detalle
                                        ? actividad.detalle.replace(/\n/g, '<br>') +
                                            (actividad.observacion
                                                ? '<br><br><strong>Observacion:</strong> ' + actividad.observacion
                                                : '')
                                        : actividad.observacion
                                            ? '<strong>Observacion:</strong> ' + actividad.observacion
                                            : 'Sin detalle disponible'
                                }">
                            </i>
                        </div>`;


        fila1Html += '</div>';
        $contentContainer.append(fila1Html);

        var $fechaContainer = $('<div>', {
            class: 'actividad-fecha flex-shrink-0 ms-2 small text-muted'
        }).text(fecha);

        $flexContainer.append($iconContainer, $contentContainer, $fechaContainer);
        $actividadDiv.append($flexContainer);

        return $actividadDiv;
    }


    // Función para filtrar por campo
    function filtrarPorCampo(campoId) {
        $('.campo-item').each(function() {
            var $campo = $(this);
            if (!campoId || $campo.data('campo-id') == campoId) {
                $campo.show();
            } else {
                $campo.hide();
            }
        });
    }
</script>

<style>
    .campo-item {
        transition: all 0.3s ease;
    }

    .lote-item {
        background-color: #f8f9fa;
        transition: all 0.2s ease;
    }

        .lote-item:hover {
            background-color: #e9ecef;
        }

    .actividad-item {
        background-color: white;
        border-radius: 0.25rem;
    }

        .actividad-item:hover {
            background-color: #f8f9fa;
        }

    .badge {
        font-size: 0.7rem;
    }
</style>