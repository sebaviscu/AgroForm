<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.35.0/dist/apexcharts.css">
</head>

<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="ph ph-cloud-rain text-primary me-2"></i>
                    <span id="tituloGrafico">Registro de Lluvias</span>
                </h5>
                <div class="d-flex gap-2">
                    <!-- Filtro por Campo -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="ph ph-layers me-1"></i>
                            <span id="filtroCampoText">Todos los Campos</span>
                        </button>
                        <ul class="dropdown-menu" id="filtroCampoMenu">
                            <li><a class="dropdown-item filtro-campo active" href="#" data-campo-id="0">Todos los Campos</a></li>
                            <!-- Se cargarán dinámicamente -->
                        </ul>
                    </div>

                    <!-- Filtro por Período -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="ph ph-funnel me-1"></i>Período
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item periodo-filter active" href="#" data-period="6">Últimos 6 meses</a></li>
                            <li><a class="dropdown-item periodo-filter" href="#" data-period="12">Últimos 12 meses</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">

                    <!-- Loading -->
                    <div id="loadingClima" class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-info" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <small class="text-muted ms-2">Cargando Luvias...</small>
                    </div>

                    <div class="col-md-9">
                        <div id="lluviaChart" style="min-height: 300px;"></div>
                    </div>
                    <div class="col-md-3">
                        <div class="lluvia-stats">
                            <h6 class="text-muted mb-3">Estadísticas</h6>
                            <div class="row text-center">
                                <div class="col-12 mb-3">
                                    <div class="stat-item">
                                        <div class="stat-value text-info fw-bold" id="totalLluvia">0.0 mm</div>
                                        <div class="stat-label small text-muted">Total Lluvia</div>
                                    </div>
                                </div>
                                <div class="col-12 mb-3">
                                    <div class="stat-item">
                                        <div class="stat-value text-primary fw-bold" id="promedioMensual">0.0 mm</div>
                                        <div class="stat-label small text-muted">Promedio Mensual Lluvia</div>
                                    </div>
                                </div>
                                <div class="col-12 mb-3">
                                    <div class="stat-item">
                                        <div class="stat-value text-secondary fw-bold" id="totalGranizo">0</div>
                                        <div class="stat-label small text-muted">Eventos de Granizo</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.35.0/dist/apexcharts.min.js"></script>

<script>
        // Variables globales
    let lluviaChart;
    let periodoActual = 6;
    let campoActual = 0;

    $(document).ready(function() {
        inicializarGrafico();
        cargarCampos();
        cargarDatosLluvia();

        // Eventos de filtro
        $('.periodo-filter').on('click', function(e) {
            e.preventDefault();
            periodoActual = $(this).data('period');
            $('.periodo-filter').removeClass('active');
            $(this).addClass('active');
            cargarDatosLluvia();
        });

        $(document).on('click', '.filtro-campo', function(e) {
            e.preventDefault();
            campoActual = $(this).data('campo-id');
            $('#filtroCampoText').text($(this).text());
            cargarDatosLluvia();
        });
    });

            function inicializarGrafico() {
        var options = {
            series: [],
            chart: {
                type: 'bar',
                height: 300,
                toolbar: {
                    show: true,
                    tools: {
                        download: true,
                        selection: false,
                        zoom: false,
                        zoomin: false,
                        zoomout: false,
                        pan: false,
                        reset: false
                    }
                }
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '70%',
                    borderRadius: 4
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function(val, opts) {
                    if (val === 0) return '';
                    var seriesName = opts.w.config.series[opts.seriesIndex].name;
                    if (seriesName.includes('Granizo')) {
                        return val /* + ' evento' + (val !== 1 ? 's' : '') */;
                    } else {
                        return val + ' mm';
                    }
                },
                offsetY: -20,
                style: {
                    fontSize: '11px',
                    colors: ["#304758"]
                }
            },
            stroke: {
                show: true,
                width: 2,
                colors: ['transparent']
            },
            xaxis: {
                categories: [],
                labels: {
                    style: {
                        fontSize: '12px'
                    }
                }
            },
            yaxis: [
                {
                    seriesName: 'Lluvia',
                    title: {
                        text: 'Milímetros (mm)'
                    },
                    labels: {
                        formatter: function(val) {
                            return val.toFixed(0) + ' mm';
                        }
                    },
                    min: 0
                },
                {
                    seriesName: 'Granizo',
                    opposite: true,
                    title: {
                        text: 'Eventos de Granizo'
                    },
                    labels: {
                        formatter: function(val) {
                            return val.toFixed(0);
                        }
                    },
                    min: 0,
                    max: 10, // Límite máximo para que no se vea tan grande
                    tickAmount: 5 // Máximo 5 marcas en el eje
                }
            ],
            fill: {
                opacity: 1
            },
            tooltip: {
                shared: true,
                intersect: false,
                y: {
                    formatter: function(val, opts) {
                        var seriesName = opts.w.config.series[opts.seriesIndex].name;
                        if (seriesName.includes('Granizo')) {
                            return val + ' evento' + (val !== 1 ? 's' : '');
                        } else {
                            return val + ' mm';
                        }
                    }
                }
            },
            colors: ['#0dcaf0', '#90979e'], // Azul para lluvia, GRIS para granizo
            legend: {
                position: 'top',
                horizontalAlign: 'center'
            }
        };

        lluviaChart = new ApexCharts(document.querySelector("#lluviaChart"), options);
        lluviaChart.render();
    }

    function cargarCampos() {
        $.ajax({
            url: '@Url.Action("GetAll", "Campo")',
            type: 'GET',
            success: function(result) {
                if (result.success && result.listObject) {
                    var menu = $('#filtroCampoMenu');
                    menu.find('.filtro-campo:not([data-campo-id="0"])').remove();

                    result.listObject.forEach(function(campo) {
                        menu.append(`
                            <li><a class="dropdown-item filtro-campo" href="#" data-campo-id="${campo.id}">${campo.nombre}</a></li>
                        `);
                    });
                }
            },
            error: function(error) {
                console.error('Error al cargar campos:', error);
            }
        });
    }

        function cargarDatosLluvia() {
        $.ajax({
            url: '@Url.Action("GetDatosLluvia", "RegistroClima")',
            type: 'GET',
            data: {
                meses: periodoActual,
                campoId: campoActual
            },
            success: function(result) {
                    $('#loadingClima').hide();
                if (result.success && result.data) {
                    actualizarGrafico(result.data);
                    actualizarEstadisticas(result.data);
                }
            },
            error: function(error) {
                    $('#loadingClima').hide();
                console.error('Error al cargar datos de lluvia:', error);
            }
        });
    }

    function actualizarGrafico(datos) {
        var categorias = datos.map(item => item.mes);
        var seriesLluvia = datos.map(item => item.totalLluvia);
        var seriesGranizo = datos.map(item => item.cantidadGranizo);

        lluviaChart.updateOptions({
            xaxis: {
                categories: categorias
            }
        });

        lluviaChart.updateSeries([
            {
                name: 'Lluvia (mm)',
                data: seriesLluvia
            },
            {
                name: 'Eventos de Granizo',
                data: seriesGranizo
            }
        ]);
    }

    function actualizarEstadisticas(datos) {
        var totalLluvia = datos.reduce((sum, item) => sum + item.totalLluvia, 0);
        var totalEventosGranizo = datos.reduce((sum, item) => sum + item.cantidadGranizo, 0);
        var promedioMensual = totalLluvia / datos.length;

        $('#totalLluvia').text(totalLluvia.toFixed(1) + ' mm');
        $('#totalGranizo').text(totalEventosGranizo);
        $('#promedioMensual').text(promedioMensual.toFixed(1) + ' mm');
    }

</script>

<style>
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }

    .lluvia-stats {
        border-left: 2px solid #e9ecef;
        padding-left: 1.5rem;
    }

    .stat-item {
        padding: 0.5rem;
    }

    .stat-value {
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.8rem;
    }

    @@media (max-width: 768px) {
        .lluvia-stats {
            border-left: none;
            border-top: 2px solid #e9ecef;
            padding-left: 0;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }
    }

    .lluvia-stats {
        border-left: 2px solid #e9ecef;
        padding-left: 1.5rem;
    }

    .stat-item {
        padding: 0.5rem;
    }

    .stat-value {
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.8rem;
    }

    @@media (max-width: 768px) {
        .lluvia-stats {
            border-left: none;
            border-top: 2px solid #e9ecef;
            padding-left: 0;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }

        .d-flex.gap-2 {
            flex-direction: column;
            gap: 0.5rem !important;
        }
    }
</style>